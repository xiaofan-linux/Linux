#DHCP原理
### 4.DHCP原理
##### DHCP租约四部曲：
![](/DHCP/image/1.png)

```
DHCP请求原理
1.客户端寻找DHCP服务器    
    客户端发送广播形式的discover，寻找DHCP服务器，源IP：0.0.0.0，目的地址：255.255.255.255
    如果DHCP服务器无响应：    
        等待1秒，    发送第二次。
        等待9秒    发送第三次。
        等待13秒    发送第四次，
        等待16秒发送第五次。
    注意：    
        1).WindowsXP sp2以后的版本只执行一次，如果还没有，就会分配一个以169开头的假IP 地址。    
        2).如果局域网内有多台DHCP服务器，谁响应的快，就从谁这里获取IP地址。
2.DHCP服务器返回地址信息    
    DHCPoffer数据包，用客户端MAC地址回应，数据包中包含IP地址
3.接收并广播    
    发送DHCPrequest广播包，告知网络中所有DHCP主机已经选定DHCP服务器    
    通过ARP协议检查IP是否可用，若被占用，则拒绝服务器offer包，重新DHCPdiscovery 
4.DHCP服务器确认    
    收到客户端发送的request包后，
    向客户端发送DHCPPack包，包含IP子网掩码，网关，DNS等网络参数
5.客户端确认    
    收到DHCPPack包后，按照内容配置网卡
6。客户端重新登录   
    发送request包，请求之前使用过的IP地址    
7、服务器确认   
    如果可用，服务器则分配DHCPPack包确认信息            
    如果不可用，服务器分配DHCPack包，告知客户端重新discovery 
```
##### 
DHCP续租
![](/DHCP/image/2.png)
##### 客户端续租

```
DHCP续租原理
1.客户端租约期限一半时（50%），向服务器发送DHCPPrequest包，要求更新租约，服务器收到回应的DHCPACK消息包，客户机就根据包中所提供的新的租期以及其它已经更新的TCP/IP参数，更新自己的配置，IP租用更新完成。            
  无回应则，再到87.5%时，再次向为其提供IP地址的DHCP服务器联系，依然得不到回应。则租约使用至到期，重新DHCPdiscovery

```
