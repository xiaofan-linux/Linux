# NFS服务端配置详解

#### 1、NFS配置文件的路径

```
/etc/exports 默认这个里面的内容是空的，这个就是nfs的配置文件。
```

#### 2、格式：

```
NFS共享目录  客户端地址1（参1，参2只读还是可写） 客户端地址2（参1，参2）
```

#### 3、参数选项说明：

```
1.共享目录：存在于我们本机上的目录，我们想共享给网络上的其他主机使用。如我要共享/tmp/data目录，那么此选项可以就直接写/tmp/data目录。
2.客户端地址1（参数1，参数2）：客户端地址能够设置一个网络，也可以设置单个主机。参数：如读写权限rw,同步更新sync,压缩来访账号all_squash，压缩后的匿名账号anonuid=uid，anongid=gid等等
```

##### 客户端地址选项说明：

| 客户端地址 | 具体地址例子 | 说明 |
| --- | --- | --- |
| 授权单一客户端访问NFS | 10.0.0.30 | 一般情况下，生产环境中此配置不多 |
| 授权整个网段可访问NFS | 10.0.0.0\/24 | 其中的\/24表示掩码为255.255.255.0.在生产环境中最常见的配置。 |
| 授权整个网段 | 10.0.0.\* | 指定网段的另外写法（需要验证） |

##### 生产环境常见配置实例

| 常用格式说明 | 要共享的目录客户端ip地址或IP段（参1，参2） |
| --- | --- |
| 配置实例1 | \/tmp\/share  10.0.0.0\/24\(rw,syn\) sync表示同步更新到磁盘，同步将内存内的文件写入到磁盘空间，保证数据不丢失，但会影响性能。 |
| 配置实例2 | home\/ryan10.0.0.0\/24\(rw,sync,all\_squash,anonuid=2000,anongid=2000\) 生产环境中常用的一种配置，适合多客户端共享一个NFS目录。All\_squash 也就是说不管客户端是以什么样的身份来进行访问的，都会被压缩成为all\_squash后面所接的用户和群组身份。这边用anonuid、anongid编号来标示。 |
| 配置实例3 | home\/atong 10.0.0.0\/24\(ro\) |

##### NFS权限设置

```
NFS配置权限设置，即/etc/exports文件配置格式中小括号（）里的参数集。
```

| 参数命令（*：使用重要程度） | 参数用途 |
| --- | --- |
| rw(*) | 表示可读写 |
| ro | Read-only表示只能读权限 |
| sync(*) | 将数据同步写入内存缓冲区与磁盘中，效率低，但可以保证数据的一致性（同步） |
| async | 将数据先保存在内存缓冲区中，必要时才写入磁盘（异步） |
| no_root_squas | 保留管理员权限，以服务器管理员的权限管理,用户应避免使用！ |
| root_squash | 将root用户的访问映射为匿名（nfsnobody）用户uid和gid |
| all_squash(*) | 不管访问nfs server共享目录的用户身份如何包括root，它的权限都将被压缩成为匿名用户，同时他们的udi和gid都会变成nobody或nfsnobody账户的uid，gid。在多个nfs客户端同时读写nfs server数据时，这个参数很有用可以确保大家写入的数据的权限是一样的。但不同系统有可能匿名用户的uid，gid不同。因为此处我们需要服务端和客户端之间的用户是一样的。比如说：服务端指定匿名用户的UID为2000，那么客户端也一定要存在2000这个账号才可以 |
| anonuid | anonuid就是匿名的uid和gid。说明客户端以什么权限来访问服务端，在默认情况下是nfsnobody。Uid65534 |
| anongid | 同anongid，就是把uid换成gid而已。 |
####提示：
    1、另外可以通过man exports查阅exports参数说明。
    2、当我们nfs配置好之后，我们可以通过cat /var/li/nfs/etab来查看,nfs配置的参数。并且这个目录很重要。/var/lib/nfs/rmtab从这个文件中我们可以看到，有哪些客户端挂载了nfs共享目录。这个两个文件是比较重要的。
        a、etab这个文件能看到服务器上共享了哪些目录，执行哪些人可以使用，并且设定的参数为何。
        b、rmtab这个文件就是能够查看到共享目录被挂载的情况。

####相关命令
    a.exportfs
        如果我们在启动了NFS之后又修改了/etc/exports，是不是还要重新启动nfs呢？这个时候我们就可以用exportfs 命令来使改动立刻生效，该命令格式如下：
        格式：exportfs [-aruv]
            -a 全部挂载或卸载 /etc/exports中的内容 
            -r 重新读取/etc/exports 中的信息 ，并同步更新/etc/exports、/var/lib/nfs/xtab
            -u 卸载单一目录（和-a一起使用为卸载所有/etc/exports文件中的目录）
            -v 在export的时候，将详细的信息输出到屏幕上。
        具体例子： 
            # exportfs -au 卸载所有共享目录
            # exportfs -ra 重新共享所有目录并输出详细信息

    b.rpcinfo利用rpcinfo -p 可以查看出RPC开启的端口所提供的程序有哪些
        其中nfs 开启的是2049，portmapper(rpcbind) 开启的是111，其余则是rpc开启的
